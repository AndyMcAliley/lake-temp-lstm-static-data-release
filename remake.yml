packages:
  - tidyverse
  - meddle # at least v0.0.12
  - scipiper
  - readr
  - sbtools
  - sf
  - arrow
  - purrr

sources:
  - src/sb_utils.R
  - src/file_utils.R
  - src/prep_helpers.R

targets:
  all:
    depends:
      - log/sb_posted_files.csv
    
  lstm_site_ids:
    command: prep_site_ids('in_data/lake_metadata_lstm.csv', is_lstm = I(TRUE))
  glm_nldas_site_ids:
    command: prep_site_ids('out_data/lake_temperature_metrics_GLM_NLDAS.csv')
  glm_gcm_site_ids:
    command: prep_site_ids('out_data/lake_temperature_metrics_GLM_GCM.csv')
  
  lake_locations_sf:
    command: prep_lake_locations(
      data_file = '../lake-temperature-model-prep/2_crosswalk_munge/out/centroid_lakes_sf.rds',
      lakes_in_release = lstm_site_ids)
  
  lake_locations_metadata:
    command: extract_feature(lake_locations_sf)
  
  out_data/lake_locations.zip:
    command: sf_to_zip(zip_filename = target_name, 
      sf_object = lake_locations_sf, layer_name = I('lake_centroids'))
  
  out_data/lake_metadata.csv:
    command: prep_lake_metadata(
      out_file = target_name,
      lake_centroids_sf = lake_locations_sf,
      lstm_metadata_file = 'in_data/lake_metadata_lstm.csv',
      glm_nldas_sites = glm_nldas_site_ids,
      glm_gcm_sites = glm_gcm_site_ids,
      lake_gnis_names_file = '../lake-temperature-model-prep/2_crosswalk_munge/out/gnisname_nhdhr_xwalk.rds',
      lake_depths_file = '../lake-temperature-model-prep/7_config_merge/out/nml_lake_depth_values.rds')
  
  crosswalk_files:
    command: list.files(I('../lake-temperature-model-prep/2_crosswalk_munge/out'), pattern = I("xwalk|crosswalk"), full.names = TRUE)
  out_data/lake_id_crosswalk.csv:
    command: prep_lake_id_crosswalk(
      out_file = target_name,
      all_crosswalk_files = crosswalk_files,
      lakes_in_release = lstm_site_ids)
  
  out_data/lake_hypsography.csv:
    command: prep_lake_hypsography(
      out_file = target_name,
      data_file = '../lake-temperature-model-prep/7_config_merge/out/nml_H_A_values.rds',
      lakes_in_release = lstm_site_ids)
  
  # Note that there are 8,670 lakes with at least one observation
  out_data/lake_temperature_observations.zip:
    command: prep_lake_temp_obs(
      out_file = target_name,
      data_file = '../lake-temperature-model-prep/7b_temp_merge/out/temp_data_with_sources.feather',
      lakes_in_release = lstm_site_ids,
      earliest_prediction = I('1979-01-02'))
  
  # TODO: meteorological_inputs_NLDAS.zip
  # TODO: meteorological_inputs_GCM.zip
  # TODO: lake_temp_preds_EALSTM_NLDAS.zip
  # TODO: lake_temp_preds_GLM_NLDAS.zip
  # TODO: lake_temp_preds_GLM_GCM.zip
  
  out_data/lake_temperature_metrics_GLM_NLDAS.csv:
    command: scipiper_copy(
      out_file = target_name,
      data_file = '../lake-temperature-out/3_summarize/out/annual_metrics_glm3_pb0nldas.csv',
      repo_path = I('..lake-temperature-out'))
      
  out_data/lake_temperature_metrics_GLM_GCM.csv:
    command: scipiper_copy(
      out_file = target_name,
      data_file = '../lake-temperature-out/3_summarize/out/annual_metrics_glm3_pb0gcm.csv',
      repo_path = I('..lake-temperature-out'))
  
  # TODO: lake_temp_preds_extraction_example.R
  # TODO: lake_temp_preds_extraction_example.py

  out_xml/fgdc_metadata.xml:
    command: render(filename = target_name,
      "in_text/text_data_release.yml",
      spatial_metadata)
    
  log/sb_posted_files.csv:
    command: sb_replace_files_log(filename = target_name, 
      sb_id = I('5faaac68d34eb413d5df1f22')
      "out_data/lake_locations.zip",
      "out_data/lake_metadata.csv",
      "out_data/lake_id_crosswalk.csv",
      "out_data/lake_hypsography.csv",
      "out_data/lake_temperature_observations.zip",
      #"out_data/meteorological_inputs_NLDAS.zip",
      #"out_data/meteorological_inputs_GCM.zip",
      #"out_data/lake_temp_preds_EALSTM_NLDAS.zip",
      #"out_data/lake_temp_preds_GLM_NLDAS.zip",
      #"out_data/lake_temp_preds_GLM_GCM.zip",
      "out_data/lake_temperature_metrics_GLM_NLDAS.csv",
      "out_data/lake_temperature_metrics_GLM_GCM.csv",
      #"out_data/lake_temp_preds_extraction_example.R",
      #"out_data/lake_temp_preds_extraction_example.py",
      "out_xml/fgdc_metadata.xml",
      sources = "src/sb_utils.R")
      

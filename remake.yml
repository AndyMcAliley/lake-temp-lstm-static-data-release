packages:
  - tidyverse
  - meddle # at least v0.0.12
  - scipiper
  - readr
  - sbtools
  - sf

sources:
  - src/sb_utils.R
  - src/file_utils.R
  - src/prep_helpers.R

targets:
  all:
    depends:
      - log/sb_posted_files.csv
    
  lstm_site_ids:
    command: prep_site_ids('in_data/lake_metadata_lstm.csv')
  
  lake_locations_sf:
    command: prep_lake_locations(
      data_file = '../lake-temperature-model-prep/2_crosswalk_munge/out/centroid_lakes_sf.rds',
      lakes_in_release = lstm_site_ids)
  
  lake_locations_metadata:
    command: extract_feature(lake_locations_sf)
  
  out_data/lake_hypsography.csv:
    command: prep_lake_hypsography(
      out_file = target_name,
      data_file = '../lake-temperature-model-prep/7_config_merge/out/nml_H_A_values.rds',
      lakes_in_release = lstm_site_ids)
  
  out_data/lake_locations.zip:
    command: sf_to_zip(zip_filename = target_name, 
      sf_object = lake_locations_sf, layer_name = I('lake_centroids'))
  
  # Note that there are 8,670 lakes with at least one observation
  out_data/lake_temperature_observations.zip:
    command: prep_lake_temp_obs(
      out_file = target_name,
      data_file = '../lake-temperature-model-prep/7b_temp_merge/out/temp_data_with_sources.feather',
      lakes_in_release = lstm_site_ids,
      earliest_prediction = I('1979-01-02'))

  out_xml/fgdc_metadata.xml:
    command: render(filename = target_name,
      "in_text/text_data_release.yml",
      spatial_metadata)
    
  log/sb_posted_files.csv:
    command: sb_replace_files_log(filename = target_name, 
      sb_id = I('5faaac68d34eb413d5df1f22'),
      "out_data/lake_hypsography.csv"
      "out_data/lake_locations.zip",
      "out_data/lake_temperature_observations.zip",
      "out_xml/fgdc_metadata.xml",
      sources = "src/sb_utils.R")
      
